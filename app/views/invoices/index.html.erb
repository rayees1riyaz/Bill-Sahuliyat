<div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6 mb-12">
    <div>
      <h1 class="text-4xl font-black text-gray-900 tracking-tight italic">Dashboard</h1>
      <p class="text-gray-500 font-medium mt-1">Manage your business invoices and stay updated with your sales.</p>
    </div>
    <div class="flex flex-col sm:flex-row items-center gap-4">
      <%# Search Bar (Moved out of frame to fix focus bug) %>
      <div class="relative w-full sm:w-80" data-controller="search">
        <%= form_with url: invoices_path, method: :get, 
                      class: "relative", 
                      data: { 
                        turbo_frame: "invoices_dashboard",
                        turbo_action: "advance",
                        search_target: "form"
                      } do |f| %>
          <%= f.text_field :query, value: params[:query], 
                           placeholder: "Search invoices...", 
                           class: "w-full pl-10 pr-12 py-3 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-brand-500 transition text-sm shadow-xl bg-white",
                           data: { action: "input->search#submit" } %>
          <div class="absolute left-3 top-3.5 text-gray-400">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
          <div class="absolute right-3 top-3.5 text-brand-600 opacity-0 transition-opacity duration-200" id="search-spinner">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        <% end %>
      </div>

      <%= link_to new_invoice_path, class: "inline-flex items-center justify-center px-8 py-4 bg-brand-600 text-white font-black rounded-2xl shadow-2xl shadow-brand-200 hover:bg-brand-700 transition transform hover:-translate-y-1 active:scale-95 text-lg uppercase tracking-wider w-full sm:w-auto" do %>
        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
        Create
      <% end %>
    </div>
  </div>

  <turbo-frame id="invoices_dashboard" class="contents">
    <%# Quick Stats %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
      <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm hover:shadow-md transition">
        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Invoices</p>
        <h3 class="text-3xl font-black text-gray-900"><%= @invoices.count %></h3>
      </div>
      <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm hover:shadow-md transition">
        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Revenue</p>
        <h3 class="text-3xl font-black text-brand-600"><%= number_to_currency(@invoices.sum(:grand_total), unit: "₹") %></h3>
      </div>
    </div>

    <div class="bg-white shadow-2xl rounded-3xl overflow-hidden border border-gray-100">
      <div class="px-8 py-6 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between">
        <h2 class="text-lg font-black text-gray-900 uppercase tracking-tight italic">Recent Transactions</h2>
        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-100 px-3 py-1 rounded-full">Real-time Search Active</span>
      </div>

      <div class="relative overflow-hidden">
      <%# Full Frame Loader Overlay %>
      <div class="absolute inset-0 bg-white/50 backdrop-blur-[1px] flex items-center justify-center z-20 opacity-0 pointer-events-none transition-opacity duration-300" id="frame-loader">
        <div class="flex flex-col items-center">
          <div class="w-10 h-10 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin"></div>
          <span class="text-[10px] font-black text-brand-700 uppercase tracking-widest mt-4 italic">Searching...</span>
        </div>
      </div>

      <div class="overflow-x-auto overflow-y-hidden">
        <table class="w-full text-left">
          <thead class="bg-gray-50/80">
            <tr>
              <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest">Inv#</th>
              <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest">Customer Details</th>
              <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest">Finance/Type</th>
              <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest">Date</th>
              <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest">Status</th>
              <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest text-right">Grand Total</th>
              <th class="px-8 py-5"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <% @invoices.each do |invoice| %>
              <tr id="<%= dom_id(invoice) %>"
                  class="hover:bg-brand-50/30 transition group cursor-pointer" 
                  data-controller="row-click" 
                  data-row-click-url-value="<%= invoice_path(invoice) %>"
                  data-action="click->row-click#go">
                <td class="px-8 py-6">
                  <span class="inline-flex items-center px-3 py-1 bg-brand-50 text-brand-700 text-xs font-black rounded-lg group-hover:bg-brand-600 group-hover:text-white transition uppercase">
                    #<%= invoice.invoice_number %>
                  </span>
                </td>
                <td class="px-8 py-6">
                  <div class="flex flex-col">
                    <span class="text-sm font-bold text-gray-900"><%= invoice.customer_name %></span>
                    <span class="text-[10px] text-gray-400 uppercase font-black tracking-tight"><%= invoice.customer_gstin.present? ? "GST: #{invoice.customer_gstin}" : "NO GSTIN" %></span>
                  </div>
                </td>
                <td class="px-8 py-6 whitespace-nowrap">
                  <% if invoice.financed_by.present? %>
                    <div class="flex flex-col">
                      <span class="text-[10px] font-black text-brand-600 uppercase tracking-widest">Financed</span>
                      <span class="text-xs font-bold text-gray-600"><%= invoice.financed_by %></span>
                    </div>
                  <% else %>
                    <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Cash/Full</span>
                  <% end %>
                </td>
                <td class="px-8 py-6 whitespace-nowrap">
                  <span class="text-sm font-medium text-gray-600"><%= invoice.invoice_date.strftime("%b %d, %Y") %></span>
                </td>
                <td class="px-8 py-6 whitespace-nowrap">
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-black bg-green-100 text-green-700 uppercase tracking-widest">Completed</span>
                </td>
                <td class="px-8 py-6 text-right whitespace-nowrap">
                  <span class="text-sm font-black text-gray-900"><%= number_to_currency(invoice.grand_total, unit: "₹") %></span>
                </td>
                <td class="px-8 py-6 text-right">
                  <div class="opacity-0 group-hover:opacity-100 transition flex justify-end space-x-2 no-print">
                    <%= link_to edit_invoice_path(invoice), class: "p-2 bg-white text-gray-500 rounded-lg shadow-sm border border-gray-100 hover:border-brand-500 hover:text-brand-600 transition", data: { turbo: false } do %>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <% end %>
                    <%= link_to invoice, class: "p-2 bg-white text-brand-600 rounded-lg shadow-sm border border-gray-100 hover:border-brand-500 transition", data: { turbo: false } do %>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <% end %>
                    <%= button_to invoice, method: :delete, 
                                  class: "p-2 bg-white text-red-500 rounded-lg shadow-sm border border-gray-100 hover:border-red-500 hover:bg-red-50 transition", 
                                  data: { turbo_confirm: "Are you sure you want to delete this invoice? This cannot be undone." } do %>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <% if @invoices.empty? %>
        <div class="p-20 text-center">
          <div class="bg-gray-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
          </div>
          <h3 class="text-lg font-black text-gray-900 uppercase tracking-tight">No invoices found</h3>
          <p class="text-gray-400 text-sm font-medium mt-1">Try adjusting your search criteria.</p>
        </div>
      <% end %>
    </div>
  </turbo-frame>
</div>
